<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compare {{ sym1 }} vs {{ sym2 }}</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa4b2;
      --accent:#60a5fa;
      color-scheme: dark;
    }
    body{
      margin:0;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,#071129 0%, #071a2a 100%);
      color: #e6eef6;
      padding:18px;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    h1{
      margin:0;
      font-size:20px;
      letter-spacing:0.2px;
    }
    .meta{
      display:flex;
      gap:12px;
      align-items:center;
      color:var(--muted);
      font-size:13px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:16px;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      padding:14px;
      border-radius:12px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.6);
    }

    .charts{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .mini-grid{
      display:grid;
      grid-template-columns: repeat(2,1fr);
      gap:10px;
    }

    .stat{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .stat .label{ color:var(--muted); font-size:12px; }
    .stat .value{ font-weight:600; font-size:16px; }

    canvas{ width:100% !important; height:260px !important; }

    .small{
      font-size:13px;
      color:var(--muted);
    }

    .footer-row{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
      flex-wrap:wrap;
    }

    .pill{
      background:rgba(255,255,255,0.03);
      padding:6px 10px;
      border-radius:999px;
      font-size:13px;
      border:1px solid rgba(255,255,255,0.02);
    }

    @media (max-width:960px){
      .grid{grid-template-columns:1fr;}
      .mini-grid{grid-template-columns:1fr;}
      canvas{height:220px !important;}
    }

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Compare: {{ sym1 }} ↔ {{ sym2 }}</h1>
        <div class="meta">
          <div class="small">Data shown: last 30 days / yearly summary (52-week)</div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="pill">Volatility = standard deviation of daily returns × 100</div>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card charts">
          <!-- Price comparison (close) -->
          <div>
            <h3 style="margin:0 0 8px 0; font-size:15px">Close Prices (30 days)</h3>
            <canvas id="priceChart"></canvas>
          </div>

          <!-- Daily returns + MA -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div class="card" style="padding:10px;">
              <h4 style="margin:0 0 8px 0; font-size:14px">Daily Returns (%)</h4>
              <canvas id="returnsChart" style="height:220px;"></canvas>
            </div>
            <div class="card" style="padding:10px;">
              <h4 style="margin:0 0 8px 0; font-size:14px">7-day MA vs Close</h4>
              <canvas id="maChart" style="height:220px;"></canvas>
            </div>
          </div>

          <!-- Correlation -->
          <div class="card" style="padding:12px;">
            <h4 style="margin:0 0 8px 0; font-size:14px">Correlation (30-day daily returns)</h4>
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
              <div class="stat">
                <div class="label">Pearson correlation</div>
                <div id="corrValue" class="value">—</div>
              </div>
              <div class="stat">
                <div class="label">Covariance</div>
                <div id="covValue" class="value">—</div>
              </div>
              <div class="small" style="max-width:60ch;">
                <strong>Interpretation:</strong> correlation close to 1 = move together, close to -1 = move opposite, near 0 = little linear relation.
              </div>
            </div>
          </div>

        </div>
      </div>

      <aside>
        <div class="card">
          <h3 style="margin:0 0 12px 0; font-size:15px">Summary — {{ sym1 }} / {{ sym2 }}</h3>

          <div class="mini-grid" style="margin-bottom:8px;">
            <div class="stat">
              <div class="label">52-week High</div>
              <div class="value">{{ sym1_data_yr.high_52 }} ({{ sym1 }})</div>
            </div>
            <div class="stat">
              <div class="label">52-week Low</div>
              <div class="value">{{ sym1_data_yr.low_52 }} ({{ sym1 }})</div>
            </div>

            <div class="stat">
              <div class="label">Avg Close (52w)</div>
              <div class="value">{{ sym1_data_yr.avg_close }}</div>
            </div>
            <div class="stat">
              <div class="label">Volatility (%)</div>
              <div class="value">{{ sym1_data_yr.volatility }}</div>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:8px 0;">

          <div class="mini-grid" style="margin-bottom:8px;">
            <div class="stat">
              <div class="label">52-week High</div>
              <div class="value">{{ sym2_data_yr.high_52 }} ({{ sym2 }})</div>
            </div>
            <div class="stat">
              <div class="label">52-week Low</div>
              <div class="value">{{ sym2_data_yr.low_52 }} ({{ sym2 }})</div>
            </div>

            <div class="stat">
              <div class="label">Avg Close (52w)</div>
              <div class="value">{{ sym2_data_yr.avg_close }}</div>
            </div>
            <div class="stat">
              <div class="label">Volatility (%)</div>
              <div class="value">{{ sym2_data_yr.volatility }}</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div class="small">Latest 30-day yearly return (percent):</div>
            <div style="display:flex;gap:12px;margin-top:8px;">
              <div class="pill">{{ sym1 }}: {{ sym1_data_month.yearly_return }}%</div>
              <div class="pill">{{ sym2 }}: {{ sym2_data_month.yearly_return }}%</div>
            </div>
          </div>

          <div class="footer-row" style="margin-top:12px;">
            <div class="small">Avg daily return (30d):</div>
            <div style="display:flex;gap:8px;">
              <div class="pill">{{ sym1 }}: {{ sym1_data_month.avg_daily_return }}%</div>
              <div class="pill">{{ sym2 }}: {{ sym2_data_month.avg_daily_return }}%</div>
            </div>
          </div>

        </div>

        <div style="height:12px;"></div>

        <div class="card">
          <h4 style="margin:0 0 8px 0;">Quick facts</h4>
          <div class="small">
            <strong>Daily return formula:</strong> (CLOSE - OPEN) / OPEN — shown in charts as percent. <br/>
            <strong>7-day MA:</strong> moving average of closing price. <br/>
            <strong>Volatility score:</strong> standard deviation of daily returns × 100.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Injected data from Flask -->
  <script>
    // Data objects passed from Flask (Jinja -> tojson)
    const s1_month = {{ sym1_data_month | tojson }};
    const s2_month = {{ sym2_data_month | tojson }};
    const s1_yr = {{ sym1_data_yr | tojson }};
    const s2_yr = {{ sym2_data_yr | tojson }};

    // Ensure arrays align: if dates mismatch, try to align by index (assumes both returned 30-day with same ordering)
    const labels = s1_month.dates.length ? s1_month.dates : s2_month.dates;

    // Helper to compute Pearson correlation and covariance
    function stats_corr(a, b){
      // assume arrays of equal length
      const n = Math.min(a.length, b.length);
      if(n === 0) return { r: NaN, cov: NaN };
      let meanA = 0, meanB = 0;
      for(let i=0;i<n;i++){ meanA += a[i]; meanB += b[i]; }
      meanA /= n; meanB /= n;
      let cov = 0, varA = 0, varB = 0;
      for(let i=0;i<n;i++){
        const da = a[i]-meanA;
        const db = b[i]-meanB;
        cov += da*db;
        varA += da*da;
        varB += db*db;
      }
      cov = cov / (n-1 || n);
      const denom = Math.sqrt(varA * varB);
      const r = denom === 0 ? 0 : (cov / Math.sqrt(varA*varB));
      return { r: r, cov: cov };
    }

    // Use daily_returns arrays (they are in percent already in returned data)
    const r1 = (s1_month.daily_returns || []).map(x => Number(x));
    const r2 = (s2_month.daily_returns || []).map(x => Number(x));

    const stat = stats_corr(r1, r2);
    // populate DOM
    document.addEventListener('DOMContentLoaded', ()=> {
      const corrEl = document.getElementById('corrValue');
      const covEl = document.getElementById('covValue');
      corrEl.textContent = isNaN(stat.r) ? 'N/A' : stat.r.toFixed(4);
      covEl.textContent = isNaN(stat.cov) ? 'N/A' : stat.cov.toFixed(6);
    });

    // Price chart (close prices both companies)
    const ctxPrice = document.getElementById('priceChart').getContext('2d');
    const priceChart = new Chart(ctxPrice, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: '{{ sym1 }} Close',
            data: s1_month.close_prices,
            tension: 0.18,
            pointRadius: 2,
            borderWidth: 2,
            borderColor: 'rgba(96,165,250,0.95)',
            yAxisID: 'y',
          },
          {
            label: '{{ sym2 }} Close',
            data: s2_month.close_prices,
            tension: 0.18,
            pointRadius: 2,
            borderWidth: 2,
            borderColor: 'rgba(34,197,94,0.95)',
            yAxisID: 'y',
          }
        ]
      },
      options: {
        responsive:true,
        interaction:{mode:'index', intersect:false},
        plugins:{
          legend:{labels:{boxWidth:12}},
          tooltip:{callbacks:{
            label: (ctx) => `${ctx.dataset.label}: ${Number(ctx.raw).toFixed(2)}`
          }}
        },
        scales:{
          x:{ display:true },
          y:{
            display:true,
            title:{display:true,text:'Price'},
            grid:{color:'rgba(255,255,255,0.03)'}
          }
        }
      }
    });

    // Returns chart (bar) — shows both companies daily returns
    const ctxReturns = document.getElementById('returnsChart').getContext('2d');
    const returnsChart = new Chart(ctxReturns, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: '{{ sym1 }} Daily Return (%)',
            data: r1,
            stack: 's1',
            borderRadius:2
          },
          {
            label: '{{ sym2 }} Daily Return (%)',
            data: r2,
            stack: 's2',
            borderRadius:2
          }
        ]
      },
      options: {
        responsive:true,
        plugins:{
          tooltip:{ callbacks:{
            label: (ctx) => `${ctx.dataset.label}: ${Number(ctx.raw).toFixed(2)}%`
          }},
          legend:{ position:'top' }
        },
        scales:{
          x:{ stacked:false },
          y:{ title:{display:true,text:'%'}, grid:{color:'rgba(255,255,255,0.03)'} }
        }
      }
    });

    // MA chart (close + MA7 for each company)
    const ma1 = s1_month.ma7.map(x => x === null ? null : Number(x));
    const ma2 = s2_month.ma7.map(x => x === null ? null : Number(x));

    const ctxMA = document.getElementById('maChart').getContext('2d');
    const maChart = new Chart(ctxMA, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: '{{ sym1 }} Close',
            data: s1_month.close_prices,
            borderDash: [],
            tension:0.18,
            pointRadius:0,
            borderWidth:1.5,
            yAxisID: 'y'
          },
          {
            label: '{{ sym1 }} MA7',
            data: ma1,
            tension:0.18,
            pointRadius:0,
            borderWidth:2,
            borderDash:[6,4],
            yAxisID: 'y'
          },
          {
            label: '{{ sym2 }} Close',
            data: s2_month.close_prices,
            tension:0.18,
            pointRadius:0,
            borderWidth:1.5,
            borderDash:[],
            yAxisID: 'y'
          },
          {
            label: '{{ sym2 }} MA7',
            data: ma2,
            tension:0.18,
            pointRadius:0,
            borderWidth:2,
            borderDash:[6,4],
            yAxisID: 'y'
          }
        ]
      },
      options:{
        responsive:true,
        plugins:{ legend:{position:'top'} },
        scales:{
          x:{ display:true },
          y:{ title:{display:true,text:'Price'} }
        }
      }
    });

    // (Optional) compute and log volatility numbers (already provided from backend)
    console.log('{{ sym1 }} volatility (backend):', s1_month.volatility || s1_yr.volatility);
    console.log('{{ sym2 }} volatility (backend):', s2_month.volatility || s2_yr.volatility);

  </script>
</body>
</html>
